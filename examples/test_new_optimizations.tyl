// Test file for new optimizations: Loop Deletion, Loop Idiom Recognition, MemCpyOpt
// Compile with: tyl -O2 -v test_new_optimizations.tyl

// ============================================
// Test 1: Loop Deletion
// Loops with no side effects and unused results should be deleted
// ============================================

fn test_loop_deletion():
    // This loop should be deleted - no side effects, result unused
    for i in range(100):
        x := i * 2  // x is never used outside the loop
    
    print("Loop deletion test passed")

// ============================================
// Test 2: Loop that should NOT be deleted
// (has side effects or result is used)
// ============================================

fn test_loop_not_deleted() -> int:
    mut sum := 0
    
    // This loop should NOT be deleted - sum is returned
    for i in range(10):
        sum += i
    
    return sum  // sum = 0+1+2+...+9 = 45

// ============================================
// Test 3: Loop with function call (side effect)
// Should NOT be deleted
// ============================================

fn side_effect_fn(x: int):
    print("Value: {x}")

fn test_loop_with_side_effects():
    // This loop should NOT be deleted - has function call
    for i in range(3):
        side_effect_fn(i)

// ============================================
// Test 4: Simple memset pattern test
// for i in 0..n { a[i] = 0 } -> should be recognized
// ============================================

fn test_memset_simple():
    // Create a list and fill it with zeros
    mut arr := [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
    
    // This pattern should be recognized as memset
    for i in range(10):
        arr[i] = 0
    
    // Verify
    mut all_zero := true
    for i in range(10):
        if arr[i] != 0:
            all_zero = false
    
    if all_zero:
        print("Memset pattern test passed")
    else:
        print("Memset pattern test FAILED")

// ============================================
// Test 5: Simple memcpy pattern test
// for i in 0..n { a[i] = b[i] } -> should be recognized
// ============================================

fn test_memcpy_simple():
    src := [10, 20, 30, 40, 50]
    mut dst := [0, 0, 0, 0, 0]
    
    // This pattern should be recognized as memcpy
    for i in range(5):
        dst[i] = src[i]
    
    // Verify
    mut copy_ok := true
    for i in range(5):
        if dst[i] != src[i]:
            copy_ok = false
    
    if copy_ok:
        print("Memcpy pattern test passed")
    else:
        print("Memcpy pattern test FAILED")

// ============================================
// Main function
// ============================================

fn main() -> int:
    print("Testing new optimizations...")
    print("")
    
    test_loop_deletion()
    
    result := test_loop_not_deleted()
    if result == 45:
        print("Loop not deleted test passed (sum = 45)")
    else:
        print("Loop not deleted test FAILED")
    
    print("")
    print("Side effects test (should print 0, 1, 2):")
    test_loop_with_side_effects()
    
    print("")
    test_memset_simple()
    test_memcpy_simple()
    
    print("")
    print("All optimization tests completed!")
    
    return 0
